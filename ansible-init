#!/usr/bin/env python3
import os
import re
import difflib
import requests
import subprocess
from pathlib import Path

project = os.path.basename(os.getcwd()).replace("-infrastructure", "")

templates_url = "https://pt.punkt.io/ansible-init/"

def diff(file1, file2):
    subprocess.run(["git", "diff", "--color-words", "--no-index", file1, file2])

def write_config(filepath):
    reference = requests.get(templates_url + filepath).text
    if re.search(r'\{\d{,1}\}', reference):
        contents = reference.format(project, os.path.basename(os.getcwd()), os.getcwd())
    else:
        contents = reference
    fullpath = os.path.join(os.getcwd(), filepath)
    if os.path.isfile(fullpath):
        with open(fullpath, "r+") as targetfile:
            fcontents = targetfile.read()
        if fcontents != contents:
            diff(fcontents, contents)
            replace = None
            print("Replace the file {}? (y/n/a)".format(fullpath))
            while replace not in ("y", "n", "a"):
                if replace == "a":
                    with open(fullpath, "w") as targetfile:
                        targetfile.write(contents)
                    break
                else:
                    replace = input()
                if replace == "y":
                    with open(fullpath, "w") as targetfile:
                        targetfile.write(contents)
                elif replace == "n":
                    pass
                else:
                    print("Please type either 'y' or 'n'")
    else:
        with open(fullpath, "w") as targetfile:
            targetfile.write(contents)
def list_files():
    tree_raw = requests.get(templates_url + "tree").text.splitlines()[1:]
    tree = [i[2:] for i in tree_raw]
    tree.remove("tree")
    return tree

for i in ["roles", "group_vars"]:
    Path(os.path.join(os.getcwd(), i)).mkdir(parents=True, exist_ok=True)
    
for config_file in list_files():
    write_config(config_file)

os.system('direnv allow')
os.system('pre-commit install')
